<project name="Build JDK Annotations" default="pack_and_check_annotations">

    <property file="manifest.properties" />

    <property name="build.number" value="@snapshot@"/>

    <property name="kannotator-cli-jar"
              value="${basedir}/out/artifacts/KAnnotatorCli/kannotator.jar"/>
    <property name="previous-jaif"
              value= "${basedir}/commandLineClient/inferred/kotlin-jdk-annotations.jaif"/>
    <property name="current-jaif"
              value= "${basedir}/out/artifacts/annotations/kotlin-jdk-annotations.jaif"/>
    <property name="annotations-dir"
              value="${basedir}/jdk-annotations-snapshot"/>
    <property name="annotations-jar"
              value="${basedir}/out/artifacts/annotations/kotlin-jdk-annotations.jar"/>

    <target name="pack_and_check_annotations"
            depends="pack_annotations,validate"/>

    <target name="validate" >
        <echo message="comparing ${previous-jaif} and ${current-jaif}"/>
        <condition property="jaif-identical">
            <filesmatch textfile="true"
                        file1="${previous-jaif}"
                        file2="${current-jaif}" />
        </condition>
        <fail unless="jaif-identical"
              message="${previous-jaif} and ${current-jaif} are different"/>
    </target>

    <target name="build_annotations">
        <java
                classname="org.jetbrains.kannotator.client.jdk.JdkPackage"
                fork="true"
                maxmemory="1024m">
        <classpath>
            <pathelement location="${kannotator-cli-jar}"/>
        </classpath>
        </java>
    </target>

    <target name="pack_annotations" depends="build_annotations">
        <jar destfile="${annotations-jar}" basedir="${annotations-dir}">
            <manifest>
                <attribute name="Built-By" value="${manifest.impl.vendor}"/>

                <attribute name="Implementation-Vendor" value="${manifest.impl.vendor}"/>
                <attribute name="Implementation-Title" value="${manifest.impl.title.kotlin.compiler.annotations.jdk}"/>
                <attribute name="Implementation-Version" value="${build.number}"/>
            </manifest>
        </jar>
        <delete dir="${basedir}/jdk-annotations-snapshot" failonerror="true"/>
    </target>
</project>
